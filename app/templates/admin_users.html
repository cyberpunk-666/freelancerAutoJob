{% extends "layout.html" %}

{% block title %}User Administration{% endblock %}

{% block content %}
<h1>User Administration</h1>

<div id="userList">
    <h2>Users</h2>
    <ul id="userListItems"></ul>
    <input type="text" id="searchInput" placeholder="Search users">
    <button class="btn btn-primary" onclick="performSearch()">Search</button>
</div>

<div id="userForm">
    <h2>Create/Edit User</h2>
    <input type="hidden" id="userId">
    <input type="text" id="userName" placeholder="User name">
    <input type="email" id="userEmail" placeholder="User email">
    <input type="password" id="userPassword" placeholder="User password">
    <button class="btn btn-primary" onclick="saveUser()">Save User</button>
</div>

<div id="userDetails" style="display: none;">
    <h2>User Details</h2>
    <h3 id="currentUserName"></h3>
    <p id="currentUserEmail"></p>
    <button class="btn btn-primary" onclick="editCurrentUser()">Edit User</button>
    <button class="btn btn-danger" onclick="deleteCurrentUser()">Delete User</button>

    <h3>User Roles</h3>
    <ul id="userRoles"></ul>
</div>

<script src="{{ url_for('static', filename='js/users.js') }}"></script>
<script>
// Function to load all users
async function loadUsers() {
    try {
        const users = await getAllUsers();
        const userList = document.getElementById('userListItems');
        userList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user.email;
            li.onclick = () => showUserDetails(user.user_id);
            userList.appendChild(li);
        });
    } catch (error) {
        console.error('Error loading users:', error);
        alert('Failed to load users. Please try again.');
    }
}

// Function to show user details
async function showUserDetails(userId) {
    try {
        const user = await getUser(userId);
        document.getElementById('currentUserName').textContent = user.name;
        document.getElementById('currentUserEmail').textContent = user.email;
        document.getElementById('userDetails').style.display = 'block';
        
        // Load user roles
        const roles = await getUserRoles(userId);
        const rolesList = document.getElementById('userRoles');
        rolesList.innerHTML = '';
        roles.forEach(role => {
            const li = document.createElement('li');
            li.textContent = role;
            rolesList.appendChild(li);
        });
    } catch (error) {
        console.error('Error showing user details:', error);
        alert('Failed to load user details. Please try again.');
    }
}

// Function to perform user search
async function performSearch() {
    const query = document.getElementById('searchInput').value;
    try {
        const users = await searchUsers(query);
        const userList = document.getElementById('userListItems');
        userList.innerHTML = '';
        users.forEach(user => {
            const li = document.createElement('li');
            li.textContent = user.name;
            li.onclick = () => showUserDetails(user.user_id);
            userList.appendChild(li);
        });
    } catch (error) {
        console.error('Error searching users:', error);
        alert('Failed to search users. Please try again.');
    }
}

// Function to save (create or update) a user
async function saveUser() {
    const userId = document.getElementById('userId').value;
    const userData = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value
    };

    try {
        if (userId) {
            await updateUser(userId, userData);
            alert('User updated successfully');
        } else {
            await createUser(userData);
            alert('User created successfully');
        }
        loadUsers(); // Reload the user list
        clearUserForm();
    } catch (error) {
        console.error('Error saving user:', error);
        alert('Failed to save user. Please try again.');
    }
}

// Function to edit the current user
function editCurrentUser() {
    const userId = document.getElementById('userId').value;
    const userName = document.getElementById('currentUserName').textContent;
    const userEmail = document.getElementById('currentUserEmail').textContent;

    document.getElementById('userId').value = userId;
    document.getElementById('userName').value = userName;
    document.getElementById('userEmail').value = userEmail;
    document.getElementById('userPassword').value = ''; // Clear password field for security
}

// Function to delete the current user
async function deleteCurrentUser() {
    const userId = document.getElementById('userId').value;
    if (confirm('Are you sure you want to delete this user?')) {
        try {
            await deleteUser(userId);
            alert('User deleted successfully');
            loadUsers(); // Reload the user list
            clearUserForm();
            document.getElementById('userDetails').style.display = 'none';
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Failed to delete user. Please try again.');
        }
    }
}

// Function to clear the user form
function clearUserForm() {
    document.getElementById('userId').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userEmail').value = '';
    document.getElementById('userPassword').value = '';
}

// Load users when the page loads
window.onload = loadUsers;
</script>
{% endblock %}
